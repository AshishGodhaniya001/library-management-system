{% extends 'base.html' %}
{% block title %}Librarian Dashboard{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h3>Librarian Dashboard</h3>
  <a class="btn btn-outline-primary" href="{% url 'admin:index' %}">Admin Panel</a>
</div>

<div class="row g-3 mb-4">
  <div class="col-md-4"><div class="card p-3"><h6>Total Copies</h6><h2 class="fw-bold">{{ total_books }}</h2></div></div>
  <div class="col-md-4"><div class="card p-3"><h6>Available Now</h6><h2 class="fw-bold">{{ total_available }}</h2></div></div>
  <div class="col-md-4"><div class="card p-3"><h6>Pending Requests</h6><h2 class="fw-bold">{{ pending.count }}</h2></div></div>
</div>

<div class="row">
  <div class="col-lg-6">
    <div class="card mb-3 p-3">
      <h6>Pending Requests</h6>
      {% if pending %}
        <ul class="list-group list-group-flush">
          {% for p in pending %}
            <li class="list-group-item d-flex justify-content-between">
              <div>
                <strong>{{ p.user.username }}</strong> — <a href="{% url 'book_detail' p.book.id %}">{{ p.book.title }}</a>
                <div><small class="text-muted">{{ p.request_date|date:"d M Y H:i" }}</small></div>
              </div>
              <div>
                <form method="post" action="{% url 'approve_issue' p.id %}">{% csrf_token %}
                  <button class="btn btn-sm btn-success">Approve</button>
                </form>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted">No pending requests.</p>
      {% endif %}
    </div>

    <div class="card p-3">
      <h6>Low Stock</h6>
      {% if low_stock %}
        <ul class="list-group">
          {% for b in low_stock %}
            <li class="list-group-item d-flex justify-content-between">
              <div>{{ b.title }}</div>
              <span class="badge bg-warning text-dark">{{ b.available_copies }}</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted">All good.</p>
      {% endif %}
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card p-3">
      <h6>Books by Category</h6>
      <canvas id="catChart" height="220"></canvas>
    </div>

    <div class="card p-3 mt-3">
      <h6>Currently Issued (recent)</h6>
      <ul class="list-group">
        {% for i in issued|slice:":8" %}
          <li class="list-group-item">
            <strong>{{ i.book.title }}</strong> — {{ i.user.username }} <br>
            <small class="text-muted">Issued: {{ i.issue_date|date:"d M" }} | Due: {{ i.due_date|date:"d M" }}</small>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>

<script>
  (function(){
    const data = {{ category_counts|safe }};
    const labels = data.map(x => x['category__name'] || 'Uncategorized');
    const counts = data.map(x => x['count']);

    const ctx = document.getElementById('catChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{ label: 'Books', data: counts }]
      },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });
  })();
</script>
{% endblock %}
